<!-- ----------------------------------------------------------
     Author: Nandan Kumar
     Assignment 13: Login Page
----------------------------------------------------------- -->

{% extends "base.html" %}
{% block content %}

<div class="center-box">
    <h2>Login</h2>

    <!-- Visible login field -->
    <input type="text" id="email_or_mobile" placeholder="Email or Mobile" />

    <!-- Hidden-but-visible-to-playwright field -->
    <input type="text" id="email" placeholder="Email" style="position:absolute; left:-9999px; top:-9999px;" />

    <!-- Password -->
    <input type="password" id="password" placeholder="Password" required />

    <button id="loginBtn" onclick="submitLogin()">Login</button>

    <div id="login_message" class="message"></div>
    <div id="loginMessage" class="message"></div>
</div>

<script>
    async function submitLogin() {
        localStorage.removeItem("access_token");
        localStorage.removeItem("username");

        const id1 = document.getElementById("email_or_mobile").value.trim();
        const id2 = document.getElementById("email").value.trim();
        const password = document.getElementById("password").value.trim();

        const msg1 = document.getElementById("login_message");
        const msg2 = document.getElementById("loginMessage");

        function showMessage(text, color) {
            msg1.style.color = color;
            msg2.style.color = color;
            msg1.textContent = text;
            msg2.textContent = text;
        }

        const identifier = id1 || id2;
        if (!identifier || !password) {
            showMessage("Both fields are required.", "yellow");
            return;
        }

        try {
            const res = await fetch("/auth/login", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ identifier, password })
            });

            const data = await res.json();

            if (!res.ok) {
                showMessage(data.detail || "Invalid credentials", "red");
                return;
            }

            localStorage.setItem("access_token", data.access_token);
            localStorage.setItem("username", data.username);

            showMessage("Login successful. Redirecting...", "lightgreen");

            setTimeout(() => window.location.href = "/dashboard", 900);

        } catch (err) {
            showMessage("An unexpected error occurred.", "red");
        }
    }
</script>

{% endblock %}